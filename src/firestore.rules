rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the user is the owner of the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to validate required fields
    function hasRequiredFields(data, fields) {
      return fields.toSet().difference(data.keys().toSet()).size() == 0;
    }

    // Helper function to check data size (prevent large payloads)
    function isValidSize(data) {
      return request.resource.size() < 1048576; // 1MB limit
    }

    // User profile and settings
    match /users/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId) && isValidSize(request.resource.data);
      allow update: if isAuthenticated() && isOwner(userId) && isValidSize(request.resource.data);
      allow delete: if isAuthenticated() && isOwner(userId);

      // Trading accounts
      match /accounts/{accountId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId)
          && hasRequiredFields(request.resource.data, ['name', 'initialBalance'])
          && request.resource.data.initialBalance is number
          && request.resource.data.initialBalance >= 0;
      }

      // Trades
      match /trades/{tradeId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow create: if isAuthenticated() && isOwner(userId)
          && hasRequiredFields(request.resource.data, ['accountId', 'date', 'asset'])
          && request.resource.data.date is timestamp
          && request.resource.data.asset is string
          && isValidSize(request.resource.data);
        allow update, delete: if isAuthenticated() && isOwner(userId);
      }

      // Strategies
      match /strategies/{strategyId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId)
          && request.resource.data.name is string
          && request.resource.data.name.size() > 0
          && request.resource.data.name.size() <= 100;
      }

      // Trading rules
      match /tradingRules/{ruleId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId)
          && request.resource.data.rule is string
          && request.resource.data.rule.size() > 0
          && request.resource.data.rule.size() <= 500;
      }

      // Mistake tags
      match /mistakeTags/{tagId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId)
          && request.resource.data.tag is string
          && request.resource.data.tag.size() > 0
          && request.resource.data.tag.size() <= 100;
      }

      // Assets
      match /assets/{assetId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId)
          && request.resource.data.name is string
          && request.resource.data.name.size() > 0
          && request.resource.data.name.size() <= 50;
      }

      // Trading model
      match /tradingModel/{modelDoc} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId);
      }

      // Settings
      match /settings/{settingDoc} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId);
      }
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
